#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>
set -e

indent() {
  sed -u 's/^/       /'
}

export BUILD_DIR=$1
export CACHE_DIR=$2
export ENV_DIR=$3

ls $3

if test -f "${ENV_DIR}/HUGO_VERSION)"; then
    HUGO_VERSION="$(cat ${ENV_DIR}/HUGO_VERSION)"
else
    HUGO_VERSION="0.68.3"
fi

OUTPUT_DIR="$(cat ${ENV_DIR}/OUTPUT_DIR)"
export HUGO_VERSION="${HUGO_VERSION:-0.54.0}"
export OUTPUT_DIR="${OUTPUT_DIR:-static}"

mkdir -vp "${BUILD_DIR}/${OUTPUT_DIR}" | indent
mkdir -vp "${CACHE_DIR}" | indent
mkdir -vp "${CACHE_DIR}/${RELEASE_NAME}" | indent

export RELEASE_NAME="hugo_extended_${HUGO_VERSION}_Linux-64bit"
export FILE_NAME="${RELEASE_NAME}.tar.gz"
export HUGO_PACKAGE="https://github.com/spf13/hugo/releases/download/v${HUGO_VERSION}/${FILE_NAME}"

echo -e "\n-----> Using Hugo ${HUGO_VERSION}"

if [ ! -e "${CACHE_DIR}/${FILE_NAME}" ]; then
  echo -e "\n-----> Fetching Hugo ${HUGO_VERSION} binaries at ${HUGO_PACKAGE}"
  curl ${HUGO_PACKAGE} -L -s -o "${CACHE_DIR}/${FILE_NAME}" | indent
else
  echo -e "\n-----> Using cached Hugo binary within ${CACHE_DIR}/${FILE_NAME}."
fi

tar -zxvf "${CACHE_DIR}/${FILE_NAME}" -C "${CACHE_DIR}" | indent
mv -v ${CACHE_DIR}/hugo ${BUILD_DIR}/hugo | indent
cd ${BUILD_DIR} || exit 10
./hugo version

echo -e "\n-----> Building site."
./hugo -v -d "${BUILD_DIR}/${OUTPUT_DIR}" | indent
echo -e "\n-----> Site built."

exit 0
